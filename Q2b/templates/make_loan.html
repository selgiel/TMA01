{% extends "base.html" %}
{% block content %}

{% if loans and loans|length > 0 %}
<div class="content-narrow px-4 mt-2">
  <div class="card shadow-sm">
    <div class="card-body">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Title / Author</th>
            <th>Borrowed</th>
            <th>Due</th>
            <th>Return date</th>
            <th>Renews</th>
            <th style="width:200px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for ln in loans %}
            <tr>
              <td style="min-width:260px;">
                <div class="d-inline-block" style="max-width:420px;">
                  {% if ln.book.url %}
                    <img src="{{ ln.book.url }}" alt="" style="height:72px; display:block; margin-bottom:6px;">
                  {% endif %}
                  <div>{{ ln.book.title }}</div>
                  <div class="mt-2">By {{ (ln.book.authors or [])|join(', ') }}</div>
                </div>
              </td>
              <td>{{ ln.borrow_date|fmtdate("%d %b %Y") }}</td>
              <td>
                {{ ln.due_date|fmtdate("%d %b %Y") }}
                {% if not ln.returned and ln.overdue %}<span class="badge bg-danger ms-1">Overdue</span>{% endif %}
              </td>
              <td>{{ ln.return_date|fmtdate("%d %b %Y") if ln.return_date else "Not yet" }}</td>
              <td>{{ ln.renew_count }}</td>
              <td>
                {% if not ln.returned %}
                  <form method="post" action="{{ url_for('catalogue_bp.return_loan', loan_id=ln.id) }}" class="d-inline">
                    <button class="btn btn-success btn-sm">Return</button>
                  </form>
                  {% if not ln.overdue and ln.renew_count < 2 %}
                    <form method="post" action="{{ url_for('catalogue_bp.renew_loan', loan_id=ln.id) }}" class="d-inline">
                      <button class="btn btn-success btn-sm">Renew</button>
                    </form>
                  {% endif %}
                {% else %}
                  <form method="post" action="{{ url_for('catalogue_bp.delete_loan', loan_id=ln.id) }}" class="d-inline">
                    <button class="btn btn-danger btn-sm">Delete</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="mt-3">
        <a href="{{ url_for('catalogue_bp.book_titles') }}" class="btn btn-success">Back to Book Titles</a>
      </div>
    </div>
  </div>
</div>
{% else %}
<div class="content-narrow ms-3 p-3 text-muted fs-4">No loan currently</div>
{% endif %}

{% endblock %}
